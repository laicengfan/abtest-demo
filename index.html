<!DOCTYPE html>
<html>

<head>
  <title>jQuery XPath plugin test page</title>
  <style type="text/css">
    body {
      font-family: Arial;
      font-size: 0.8em;
    }

    p {
      margin-top: 0.5em;
      margin-bottom: 0.5em;
    }

    html,
    html body {
      width: 100%;
      height: 100%;
    }

    .ab {
      height: 100%;
    }

    iframe {
      width: 100%;
      height: 90%;
    }
  </style>
</head>

<body>
  
  <button id="addSelect">开始添加ABTest</button>
  <button id="addStyles">应用ABTest</button>
  <input value="/test/test-path2.html" id="ip-url" />
  <button id="btn-go"> go </button>
  <span> | </span>
  <button id="btn-check-sdk"> 检测SDK </button>
  <button id="btn-start"> Start </button>
  <button id="btn-active"> Active </button>
  <div class="ab">
    <iframe id="iframe" src="./test-path2.html">
    </iframe>
    

    <script type="text/javascript">
      function loadJS(doc, url, callback) {

        var script = doc.createElement('script'),

          fn = callback || function () {};

        script.type = 'text/javascript';



        //IE

        if (script.readyState) {

          script.onreadystatechange = function () {

            if (script.readyState == 'loaded' || script.readyState == 'complete') {

              script.onreadystatechange = null;

              fn();

            }

          };

        } else {

          //其他浏览器

          script.onload = function () {

            fn();

          };

        }

        script.src = url;

        doc.getElementsByTagName('head')[0].appendChild(script);

      }

      // loadJS(document,'./js/myXpath.js',function(){
      //         console.log('finish 1');
      //     });

      document.getElementById('addSelect').addEventListener('click', function () {
        var obj = document.getElementById("iframe").contentWindow.document;
        loadJS(obj, './js/myXpath.js', function () {
          console.log('finish 1');
        });
      });

      document.getElementById('addStyles').addEventListener('click', function () {
        var obj = document.getElementById("iframe").contentWindow.document;
        loadJS(obj, './js/myNewVersion.js', function () {
          console.log('finish 2');
        });
      });

    document.getElementById('btn-go').addEventListener('click', function () {
      document.getElementById("iframe").src = document.getElementById('ip-url').value;
    });

    function domainURI(str){  
      var durl=/http:\/\/([^\/]+)\//i;  
      domain = str.match(durl);  
      return domain[1];  
    }  
  
    let checkSdk = false;
    let subOrigin = '*';

    document.getElementById('btn-check-sdk').addEventListener('click', function () {
      checkSdk = false;
      window.frames[0].postMessage({
        method:'check-sdk'
      },subOrigin);
      setTimeout(() => {
        if(!checkSdk)
        {
          alert('未安装sdk！');
        }
      }, 2000);
    });

    document.getElementById('btn-start').addEventListener('click', function () {
      window.frames[0].postMessage({
        method:'start'
      },subOrigin);
    });
    document.getElementById('btn-active').addEventListener('click', function () {
      window.frames[0].postMessage({
        method:'render'
      },subOrigin);
    });

    window.addEventListener("message", receiveMessage, false);

    function receiveMessage(event)
    {
      if(event.data.method == 'check-sdk-ok')
      {
        checkSdk = true;
        alert('sdk安装成功');
      }
      // For Chrome, the origin property is in the event.originalEvent
      // object.
      // 这里不准确，chrome没有这个属性
      // var origin = event.origin || event.originalEvent.origin;
      var origin = event.origin
      if (origin !== "http://example.org:8080")
        return;

      // ...
    }

  </script>


</body>

</html>